name: CI/CD to Cloud Foundry with Prometheus & Grafana

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # ğŸ§± Checkout source
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # ğŸ§© Setup Node.js for Angular
      # -------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'

      # -------------------------------
      # ğŸ§± Build Angular
      # -------------------------------
      - name: Build Angular frontend
        working-directory: frontend
        run: |
          npm ci
          npx ng build --configuration production
          echo "âœ… Angular build done."

      # -------------------------------
      # â˜• Setup Java + Maven
      # -------------------------------
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'


      # -------------------------------
      # ğŸ—ï¸ Build Spring Boot backend
      # -------------------------------
      - name: Build Spring Boot backend
        working-directory: backend
        run: |
          rm -rf src/main/resources/static/*
          mkdir -p src/main/resources/static
          cp -r ../frontend/dist/frontend/* src/main/resources/static/
          mvn clean package -DskipTests
          echo "âœ… Backend JAR built."

      # -------------------------------
      # â˜ï¸ Deploy to Cloud Foundry
      # -------------------------------
      - name: Set up Cloud Foundry CLI
        uses: cloudfoundry/cf-cli-action@v1
        with:
          version: '8.7.1'


      - name: Deploy to Cloud Foundry
        run: |
          cf login -a ${{ secrets.CF_API }} -u ${{ secrets.CF_USERNAME }} -p ${{ secrets.CF_PASSWORD }} -o ${{ secrets.CF_ORG }} -s ${{ secrets.CF_SPACE }}
          cd backend
          cf push

      # -------------------------------
      # ğŸ“Š Create Prometheus & Grafana services
      # -------------------------------
      - name: Create Prometheus & Grafana services
        run: |
          cf create-service prometheus standard prometheus-service || echo "Prometheus already exists"
          cf create-service grafana standard grafana-service || echo "Grafana already exists"
          cf bind-service demo-backend prometheus-service || echo "Already bound"
          cf bind-service prometheus-service grafana-service || echo "Grafana already bound"
          cf restage demo-backend
          echo "âœ… Monitoring stack deployed."

      # -------------------------------
      # ğŸ” Get Grafana dashboard URL
      # -------------------------------
      - name: Show Grafana service details
        run: |
          cf service grafana-service
