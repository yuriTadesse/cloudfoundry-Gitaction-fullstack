name: CI/CD to Cloud Foundry with Prometheus & Grafana

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # üß± Checkout source
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # üß© Setup Node.js for Angular
      # -------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'

      # -------------------------------
      # üß± Build Angular
      # -------------------------------
      - name: Build Angular frontend
        working-directory: frontend
        run: |
          npm ci
          npx ng build --configuration production
          echo "‚úÖ Angular build done."

      # -------------------------------
      # ‚òï Setup Java + Maven
      # -------------------------------
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # -------------------------------
      # üèóÔ∏è Build Spring Boot backend
      # -------------------------------
      - name: Build Spring Boot backend
        working-directory: backend
        run: |
          rm -rf src/main/resources/static/*
          mkdir -p src/main/resources/static
          cp -r ../frontend/dist/frontend/* src/main/resources/static/
          mvn clean package -DskipTests
          echo "‚úÖ Backend JAR built."

      # -------------------------------
      # ‚òÅÔ∏è Deploy to Cloud Foundry
      # -------------------------------
      - name: Deploy to Cloud Foundry
        uses: citizen-of-planet-earth/cf-cli-action@v2
        with:
          cf_api: ${{ secrets.CF_API }}
          cf_username: ${{ secrets.CF_USERNAME }}
          cf_password: ${{ secrets.CF_PASSWORD }}
          cf_org: ${{ secrets.CF_ORG }}
          cf_space: ${{ secrets.CF_SPACE }}
          command: push
        env:
          CF_DOCKER_PASSWORD: ${{ secrets.CF_PASSWORD }}

      # -------------------------------
      # üìä Create Prometheus & Grafana services
      # -------------------------------
      - name: Create Prometheus & Grafana services
        run: |
          cf create-service prometheus standard prometheus-service || echo "Prometheus already exists"
          cf create-service grafana standard grafana-service || echo "Grafana already exists"
          cf bind-service demo-backend prometheus-service || echo "Already bound"
          cf bind-service prometheus-service grafana-service || echo "Grafana already bound"
          cf restage demo-backend
          echo "‚úÖ Monitoring stack deployed."

      # -------------------------------
      # üîç Get Grafana dashboard URL
      # -------------------------------
      - name: Show Grafana service details
        run: |
          cf service grafana-service
