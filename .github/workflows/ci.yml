name: build-and-deploy

on:
  push:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FRONTEND_APP: demo-frontend
      BACKEND_APP: demo-backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- Frontend: Angular build ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'

      - name: Build Angular frontend
        working-directory: frontend
        run: |
          npm ci --legacy-peer-deps
          npx ng build --configuration production
          echo "✅ Angular build done."

      # ---------- Backend: Maven build ----------
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build Spring Boot backend
        working-directory: backend
        run: |
          # (optional) also serve the SPA from backend if desired
          rm -rf src/main/resources/static/* || true
          mkdir -p src/main/resources/static
          cp -r ../frontend/dist/* src/main/resources/static/ || true
          mvn -B clean package -DskipTests
          echo "✅ Backend JAR built."

      # ---------- Cloud Foundry CLI ----------
      - name: Install Cloud Foundry CLI
        run: |
          wget -q -O cf-cli.tgz "https://packages.cloudfoundry.org/stable?release=linux64-binary&version=8.7.1"
          tar -xzf cf-cli.tgz
          sudo mv $(find . -type f -name 'cf*' -perm -111 | head -n 1) /usr/local/bin/cf
          cf --version

      - name: CF Login
        run: |
          cf login -a "${{ secrets.CF_API }}" \
                   -u "${{ secrets.CF_USERNAME }}" \
                   -p "${{ secrets.CF_PASSWORD }}" \
                   -o "${{ secrets.CF_ORG }}" \
                   -s "${{ secrets.CF_SPACE }}"

      # ---------- (Optional) route cleanup to avoid quota errors ----------
      - name: Route cleanup (optional)
        run: |
          if [ -z "${{ secrets.CF_DOMAIN }}" ]; then
            echo "Skipping cleanup — no CF_DOMAIN secret."
            exit 0
          fi

          cf unmap-route "$BACKEND_APP" "${{ secrets.CF_DOMAIN }}" --hostname "$BACKEND_APP" || true
          cf delete-route "${{ secrets.CF_DOMAIN }}" --hostname "$FRONTEND_APP" -f || true
      

      # ---------- Deploy backend using its manifest ----------
      - name: Deploy backend
        working-directory: backend
        run: |
          echo "Deploying backend..."
          if ! cf push -f manifest.yml; then
            echo "⚠️ Backend deployment failed due to quota (likely routes). Continuing to frontend deploy..."
          fi
          echo "Backend step completed."
      

      # ---------- Deploy frontend as separate CF app (Staticfile buildpack) ----------
      - name: Deploy frontend
        working-directory: frontend
        run: |
          # find Angular dist subfolder (dist/<project-name>)
          DIST_DIR=$(ls -d dist/* | head -n 1)
          # ensure Staticfile sits inside dist root for Staticfile buildpack
          cp -n Staticfile "$DIST_DIR"/ 2>/dev/null || true
          # push using frontend/manifest.yml, pointing to dist/* as path
          cf push -f manifest.yml -p "$DIST_DIR"

      # ---------- Map a friendly route for frontend (optional) ----------
      - name: Map frontend route (optional)
        run: |
          if [ -z "${{ secrets.CF_DOMAIN }}" ]; then
            echo "⚠️ CF_DOMAIN not set — skipping route mapping."
            exit 0
          fi

          cf map-route "$FRONTEND_APP" "${{ secrets.CF_DOMAIN }}" --hostname "$FRONTEND_APP" || true
          echo "Frontend mapped to: https://$FRONTEND_APP.${{ secrets.CF_DOMAIN }}"
      
